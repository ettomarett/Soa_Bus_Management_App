kind: pipeline
type: docker
name: build-and-deploy

# Enable cancellation support
concurrency:
  limit: 1

steps:
  - name: detect-changed-services
    image: alpine/git:latest
    commands:
      - apk add --no-cache bash
      - |
        echo "üîç Detecting changed services..."
        CHANGED_SERVICES=""
        
        # Get list of changed files compared to previous commit
        if [ "$DRONE_COMMIT_BEFORE" != "0000000000000000000000000000000000000000" ]; then
          CHANGED_FILES=$(git diff --name-only $DRONE_COMMIT_BEFORE $DRONE_COMMIT_AFTER || git diff --name-only HEAD~1 HEAD)
        else
          # First commit or no previous commit, check all files
          CHANGED_FILES=$(git ls-files)
        fi
        
        # Detect which services changed
        echo "$CHANGED_FILES" | grep -q "^User/" && CHANGED_SERVICES="$CHANGED_SERVICES user-service" || true
        echo "$CHANGED_FILES" | grep -q "^Ticket/" && CHANGED_SERVICES="$CHANGED_SERVICES ticket-service" || true
        echo "$CHANGED_FILES" | grep -q "^Subscription/" && CHANGED_SERVICES="$CHANGED_SERVICES subscription-service" || true
        echo "$CHANGED_FILES" | grep -q "^Route/" && CHANGED_SERVICES="$CHANGED_SERVICES route-service" || true
        echo "$CHANGED_FILES" | grep -q "^BusGeolocation/" && CHANGED_SERVICES="$CHANGED_SERVICES bus-geolocation-service" || true
        echo "$CHANGED_FILES" | grep -q "^Notification/" && CHANGED_SERVICES="$CHANGED_SERVICES notification-service" || true
        echo "$CHANGED_FILES" | grep -q "^api-gateway/" && CHANGED_SERVICES="$CHANGED_SERVICES api-gateway" || true
        echo "$CHANGED_FILES" | grep -q "^Frontend/" && CHANGED_SERVICES="$CHANGED_SERVICES frontend" || true
        echo "$CHANGED_FILES" | grep -q "^pom.xml\|^\.drone.yml\|^docker-compose" && CHANGED_SERVICES="all" || true
        
        # If no specific services changed but root files changed, rebuild all
        if [ -z "$CHANGED_SERVICES" ]; then
          CHANGED_SERVICES="all"
        fi
        
        # Trim whitespace
        CHANGED_SERVICES=$(echo $CHANGED_SERVICES | xargs)
        
        echo "üì¶ Changed services: $CHANGED_SERVICES"
        echo "CHANGED_SERVICES=$CHANGED_SERVICES" > /drone/src/changed_services.txt
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-user-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "user-service"; then
          echo "üî® Building User service..."
          mvn clean package -DskipTests -pl User -am
          echo "‚úÖ User service build completed"
        else
          echo "‚è≠Ô∏è  User service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-ticket-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "ticket-service"; then
          echo "üî® Building Ticket service..."
          mvn clean package -DskipTests -pl Ticket -am
          echo "‚úÖ Ticket service build completed"
        else
          echo "‚è≠Ô∏è  Ticket service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-subscription-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "subscription-service"; then
          echo "üî® Building Subscription service..."
          mvn clean package -DskipTests -pl Subscription -am
          echo "‚úÖ Subscription service build completed"
        else
          echo "‚è≠Ô∏è  Subscription service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-route-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "route-service"; then
          echo "üî® Building Route service..."
          mvn clean package -DskipTests -pl Route -am
          echo "‚úÖ Route service build completed"
        else
          echo "‚è≠Ô∏è  Route service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-bus-geolocation-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "bus-geolocation-service"; then
          echo "üî® Building BusGeolocation service..."
          mvn clean package -DskipTests -pl BusGeolocation -am
          echo "‚úÖ BusGeolocation service build completed"
        else
          echo "‚è≠Ô∏è  BusGeolocation service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-notification-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "notification-service"; then
          echo "üî® Building Notification service..."
          mvn clean package -DskipTests -pl Notification -am
          echo "‚úÖ Notification service build completed"
          ls -la Notification/target/*.jar || echo "‚ö†Ô∏è  Notification JAR not found!"
        else
          echo "‚è≠Ô∏è  Notification service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-api-gateway
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "api-gateway"; then
          echo "üî® Building API Gateway..."
          mvn clean package -DskipTests -pl api-gateway -am
          echo "‚úÖ API Gateway build completed"
        else
          echo "‚è≠Ô∏è  API Gateway unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: deploy-to-vps
    image: alpine/git:latest
    environment:
      VPS_HOST:
        from_secret: vps_host
      VPS_USER:
        from_secret: vps_user
      VPS_SSH_KEY:
        from_secret: vps_ssh_key
      DOCKER_USERNAME:
        from_secret: ghcr_username
      DOCKER_PASSWORD:
        from_secret: ghcr_token
    commands:
      - apk add --no-cache openssh-client rsync
      - mkdir -p ~/.ssh
      - echo "$$VPS_SSH_KEY" > ~/.ssh/deploy_key
      - chmod 600 ~/.ssh/deploy_key
      - ssh-keyscan -H $$VPS_HOST >> ~/.ssh/known_hosts || true
      - echo "üì¶ Copying source code to VPS..."
      - echo "VPS_HOST=$$VPS_HOST, VPS_USER=$$VPS_USER"
      - |
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          $${DRONE_WORKSPACE}/ \
          "$$VPS_USER@$$VPS_HOST:/opt/soa-bus-app/"
      - echo "üöÄ Building and deploying services on VPS..."
      - |
        # Read changed services and pass to VPS
        CHANGED_SERVICES=$(cat /tmp/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        echo "üì¶ Changed services to build: $CHANGED_SERVICES"
        
        # Debug: Check if credentials are available (without printing values)
        echo "üîç Checking Docker credentials..."
        if [ -n "$$DOCKER_USERNAME" ]; then
          echo "   DOCKER_USERNAME is SET"
        else
          echo "   DOCKER_USERNAME is NOT SET"
        fi
        if [ -n "$$DOCKER_PASSWORD" ]; then
          echo "   DOCKER_PASSWORD is SET"
        else
          echo "   DOCKER_PASSWORD is NOT SET"
        fi
        
        if [ -z "$$DOCKER_USERNAME" ] || [ -z "$$DOCKER_PASSWORD" ]; then
          echo "‚ùå ERROR: DOCKER_USERNAME or DOCKER_PASSWORD is empty!"
          echo "   Please verify that repository secrets 'ghcr_username' and 'ghcr_token' exist"
          exit 1
        fi
        echo "‚úÖ Docker credentials are available"
        
        # Extract short commit SHA (first 8 characters)
        COMMIT_SHA_FULL="$$DRONE_COMMIT_SHA"
        COMMIT_SHA_SHORT="$${COMMIT_SHA_FULL:0:8}"
        
        # Pass credentials via SSH using base64 encoding to safely pass values
        # Alpine's base64 doesn't support -w flag, so we remove newlines manually
        DOCKER_USERNAME_B64=$(printf '%s' "$$DOCKER_USERNAME" | base64 | tr -d '\n')
        DOCKER_PASSWORD_B64=$(printf '%s' "$$DOCKER_PASSWORD" | base64 | tr -d '\n')
        
        # Debug: Verify base64 encoding worked
        if [ -z "$$DOCKER_USERNAME_B64" ] || [ -z "$$DOCKER_PASSWORD_B64" ]; then
          echo "‚ùå ERROR: Base64 encoding failed!"
          echo "   DOCKER_USERNAME length: ${#DOCKER_USERNAME}"
          echo "   DOCKER_PASSWORD length: ${#DOCKER_PASSWORD}"
          exit 1
        fi
        echo "‚úÖ Base64 encoding successful (lengths: ${#DOCKER_USERNAME_B64}, ${#DOCKER_PASSWORD_B64})"
        
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$$VPS_USER@$$VPS_HOST" \
          DOCKER_USERNAME_B64="$$DOCKER_USERNAME_B64" \
          DOCKER_PASSWORD_B64="$$DOCKER_PASSWORD_B64" \
          COMMIT_SHA_VAR="$$COMMIT_SHA_SHORT" \
          bash -s << 'DEPLOYSCRIPT'
          cd /opt/soa-bus-app
          
          # Debug: Check base64 variables received
          echo "üîç DEBUG: Base64 variables received:"
          echo "   DOCKER_USERNAME_B64 is ${DOCKER_USERNAME_B64:+SET (length: ${#DOCKER_USERNAME_B64})}${DOCKER_USERNAME_B64:-NOT SET}"
          echo "   DOCKER_PASSWORD_B64 is ${DOCKER_PASSWORD_B64:+SET (length: ${#DOCKER_PASSWORD_B64})}${DOCKER_PASSWORD_B64:-NOT SET}"
          echo "   COMMIT_SHA_VAR is ${COMMIT_SHA_VAR:-NOT SET}"
          
          # Decode credentials from base64
          DOCKER_USERNAME_VAR=$(echo "$DOCKER_USERNAME_B64" | base64 -d)
          DOCKER_PASSWORD_VAR=$(echo "$DOCKER_PASSWORD_B64" | base64 -d)
          
          # Debug: Check decoded credentials
          echo "üîç DEBUG: Decoded credentials:"
          echo "   DOCKER_USERNAME_VAR is ${DOCKER_USERNAME_VAR:+SET (length: ${#DOCKER_USERNAME_VAR})}${DOCKER_USERNAME_VAR:-NOT SET}"
          echo "   DOCKER_PASSWORD_VAR is ${DOCKER_PASSWORD_VAR:+SET (length: ${#DOCKER_PASSWORD_VAR})}${DOCKER_PASSWORD_VAR:-NOT SET}"
          
          # Load .env if it exists
          if [ -f .env ]; then
            set -a && source .env && set +a
          fi
          
          # Get commit SHA from environment or git
          echo "üîç DEBUG: Before setting COMMIT_SHA - COMMIT_SHA_VAR='$COMMIT_SHA_VAR'"
          if [ -n "$COMMIT_SHA_VAR" ] && [ "$COMMIT_SHA_VAR" != "" ]; then
            COMMIT_SHA="$COMMIT_SHA_VAR"
            echo "üîç DEBUG: Set COMMIT_SHA from COMMIT_SHA_VAR: '$COMMIT_SHA'"
          else
            COMMIT_SHA=$(git rev-parse --short=8 HEAD 2>/dev/null || echo "latest")
            echo "üîç DEBUG: Set COMMIT_SHA from git: '$COMMIT_SHA'"
          fi
          # Export COMMIT_SHA so it's available to all functions
          export COMMIT_SHA
          echo "üîç DEBUG: After export - COMMIT_SHA='$COMMIT_SHA', checking export..."
          env | grep COMMIT_SHA || echo "‚ö†Ô∏è  COMMIT_SHA not found in environment"
          echo "üìù Commit SHA: $COMMIT_SHA (from COMMIT_SHA_VAR: $COMMIT_SHA_VAR)"
          
          # Debug: Check credentials
          if [ -z "$DOCKER_USERNAME_VAR" ] || [ -z "$DOCKER_PASSWORD_VAR" ]; then
            echo "‚ö†Ô∏è  ERROR: DOCKER_USERNAME_VAR or DOCKER_PASSWORD_VAR is empty!"
            exit 1
          fi
          echo "‚úÖ Docker credentials received"
          
          # Detect changed services on VPS using git
          CHANGED_SERVICES_VPS="all"
          if [ -d .git ]; then
            PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "")
            if [ -n "$PREV_COMMIT" ]; then
              CHANGED_FILES=$(git diff --name-only $PREV_COMMIT HEAD 2>/dev/null || echo "")
              if [ -n "$CHANGED_FILES" ]; then
                CHANGED_SERVICES_VPS=""
                echo "$CHANGED_FILES" | grep -q "^User/" && CHANGED_SERVICES_VPS="$CHANGED_SERVICES_VPS user-service" || true
                echo "$CHANGED_FILES" | grep -q "^Ticket/" && CHANGED_SERVICES_VPS="$CHANGED_SERVICES_VPS ticket-service" || true
                echo "$CHANGED_FILES" | grep -q "^Subscription/" && CHANGED_SERVICES_VPS="$CHANGED_SERVICES_VPS subscription-service" || true
                echo "$CHANGED_FILES" | grep -q "^Route/" && CHANGED_SERVICES_VPS="$CHANGED_SERVICES_VPS route-service" || true
                echo "$CHANGED_FILES" | grep -q "^BusGeolocation/" && CHANGED_SERVICES_VPS="$CHANGED_SERVICES_VPS bus-geolocation-service" || true
                echo "$CHANGED_FILES" | grep -q "^Notification/" && CHANGED_SERVICES_VPS="$CHANGED_SERVICES_VPS notification-service" || true
                echo "$CHANGED_FILES" | grep -q "^api-gateway/" && CHANGED_SERVICES_VPS="$CHANGED_SERVICES_VPS api-gateway" || true
                echo "$CHANGED_FILES" | grep -q "^Frontend/" && CHANGED_SERVICES_VPS="$CHANGED_SERVICES_VPS frontend" || true
                echo "$CHANGED_FILES" | grep -q "^pom.xml\|^\.drone.yml\|^docker-compose" && CHANGED_SERVICES_VPS="all" || true
                CHANGED_SERVICES_VPS=$(echo $CHANGED_SERVICES_VPS | xargs)
                [ -z "$CHANGED_SERVICES_VPS" ] && CHANGED_SERVICES_VPS="all" || true
              fi
            fi
          fi
          
          echo "üîê Logging in to GHCR..."
          if [ -z "$DOCKER_USERNAME_VAR" ] || [ -z "$DOCKER_PASSWORD_VAR" ]; then
            echo "‚ùå ERROR: Docker credentials are missing!"
            echo "   DOCKER_USERNAME_VAR: ${DOCKER_USERNAME_VAR:+SET}"
            echo "   DOCKER_PASSWORD_VAR: ${DOCKER_PASSWORD_VAR:+SET}"
            exit 1
          fi
          echo "${DOCKER_PASSWORD_VAR}" | docker login ghcr.io -u "${DOCKER_USERNAME_VAR}" --password-stdin
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: Docker login failed!"
            exit 1
          fi
          echo "‚úÖ Docker login successful"
          
          echo "üìù Using commit SHA: $COMMIT_SHA"
          echo "üîç DEBUG: Before function definition - COMMIT_SHA='$COMMIT_SHA'"
          echo "üîç DEBUG: Checking if COMMIT_SHA is exported: $(export -p | grep COMMIT_SHA || echo 'Not exported')"
          
          # Build JARs on VPS if needed (for services that require it)
          echo "üî® Building Java services with Maven on VPS..."
          if command -v mvn >/dev/null 2>&1; then
            if [ "$CHANGED_SERVICES_VPS" = "all" ]; then
              mvn clean package -DskipTests || echo "‚ö†Ô∏è  Maven build failed, continuing with Docker build"
            else
              # Build only changed Java services
              MAVEN_MODULES_VPS=""
              echo "$CHANGED_SERVICES_VPS" | grep -q "user-service" && MAVEN_MODULES_VPS="$MAVEN_MODULES_VPS User" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "ticket-service" && MAVEN_MODULES_VPS="$MAVEN_MODULES_VPS Ticket" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "subscription-service" && MAVEN_MODULES_VPS="$MAVEN_MODULES_VPS Subscription" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "route-service" && MAVEN_MODULES_VPS="$MAVEN_MODULES_VPS Route" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "bus-geolocation-service" && MAVEN_MODULES_VPS="$MAVEN_MODULES_VPS BusGeolocation" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "notification-service" && MAVEN_MODULES_VPS="$MAVEN_MODULES_VPS Notification" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "api-gateway" && MAVEN_MODULES_VPS="$MAVEN_MODULES_VPS api-gateway" || true
              if [ -n "$MAVEN_MODULES_VPS" ]; then
                mvn clean package -DskipTests -pl $MAVEN_MODULES_VPS -am || echo "‚ö†Ô∏è  Maven build failed, continuing with Docker build"
              fi
            fi
            echo "‚úÖ Maven build completed on VPS"
          else
            echo "‚ö†Ô∏è  Maven not found on VPS, assuming JARs are already built"
          fi
          
          # Function to build and push a service
          build_and_push() {
            local SERVICE_NAME=$1
            local DOCKERFILE=$2
            local IMAGE_NAME=$3
            local BUILD_ARGS=$4
            
            # Use the username from environment variable
            local DOCKER_USER="${DOCKER_USERNAME_VAR:-ettomarett}"
            local IMAGE_TAG="ghcr.io/${DOCKER_USER}/${IMAGE_NAME}"
            
            # Get TAG_SHA from exported COMMIT_SHA
            local TAG_SHA="${COMMIT_SHA:-latest}"
            
            echo "üî® Building $SERVICE_NAME..."
            echo "   Image: ${IMAGE_TAG}:${TAG_SHA}"
            echo "   Dockerfile: $DOCKERFILE"
            
            if [ -n "$BUILD_ARGS" ]; then
              docker build $BUILD_ARGS -t "${IMAGE_TAG}:${TAG_SHA}" -t "${IMAGE_TAG}:latest" -f "$DOCKERFILE" .
            else
              docker build -t "${IMAGE_TAG}:${TAG_SHA}" -t "${IMAGE_TAG}:latest" -f "$DOCKERFILE" .
            fi
            
            if [ $? -eq 0 ]; then
              echo "üì§ Pushing $SERVICE_NAME..."
              docker push "${IMAGE_TAG}:${TAG_SHA}"
              docker push "${IMAGE_TAG}:latest"
              echo "‚úÖ $SERVICE_NAME built and pushed successfully"
            else
              echo "‚ùå Failed to build $SERVICE_NAME"
              return 1
            fi
          }
          
            if [ "$CHANGED_SERVICES_VPS" = "all" ]; then
              echo "üî® Building all services..."
              build_and_push "user-service" "User/Dockerfile" "soa-bus-app-user-service"
              build_and_push "ticket-service" "Ticket/Dockerfile" "soa-bus-app-ticket-service"
              build_and_push "subscription-service" "Subscription/Dockerfile" "soa-bus-app-subscription-service"
              build_and_push "route-service" "Route/Dockerfile" "soa-bus-app-route-service"
              build_and_push "bus-geolocation-service" "BusGeolocation/Dockerfile" "soa-bus-app-bus-geolocation-service"
              build_and_push "notification-service" "Notification/Dockerfile" "soa-bus-app-notification-service"
              build_and_push "api-gateway" "api-gateway/Dockerfile" "soa-bus-app-api-gateway"
              build_and_push "frontend" "Frontend/Dockerfile" "soa-bus-app-frontend" "--build-arg REACT_APP_API_URL=https://nassar.clueleak.com/api/v1 --build-arg REACT_APP_USER_SERVICE_URL=https://nassar.clueleak.com/api/v1"
            else
              echo "üî® Building only changed services: $CHANGED_SERVICES_VPS"
              echo "$CHANGED_SERVICES_VPS" | grep -q "user-service" && build_and_push "user-service" "User/Dockerfile" "soa-bus-app-user-service" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "ticket-service" && build_and_push "ticket-service" "Ticket/Dockerfile" "soa-bus-app-ticket-service" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "subscription-service" && build_and_push "subscription-service" "Subscription/Dockerfile" "soa-bus-app-subscription-service" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "route-service" && build_and_push "route-service" "Route/Dockerfile" "soa-bus-app-route-service" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "bus-geolocation-service" && build_and_push "bus-geolocation-service" "BusGeolocation/Dockerfile" "soa-bus-app-bus-geolocation-service" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "notification-service" && build_and_push "notification-service" "Notification/Dockerfile" "soa-bus-app-notification-service" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "api-gateway" && build_and_push "api-gateway" "api-gateway/Dockerfile" "soa-bus-app-api-gateway" || true
              echo "$CHANGED_SERVICES_VPS" | grep -q "frontend" && build_and_push "frontend" "Frontend/Dockerfile" "soa-bus-app-frontend" "--build-arg REACT_APP_API_URL=https://nassar.clueleak.com/api/v1 --build-arg REACT_APP_USER_SERVICE_URL=https://nassar.clueleak.com/api/v1" || true
            fi
          
          # Use docker-compose.production.yml if it exists, otherwise use docker-compose.yml
          if [ -f docker-compose.production.yml ]; then
            COMPOSE_FILE="docker-compose.production.yml"
          elif [ -f docker-compose.yml ]; then
            COMPOSE_FILE="docker-compose.yml"
            echo "Using docker-compose.yml (production file not found)"
          else
            echo "No docker-compose file found!"
            exit 1
          fi
          
          echo "üöÄ Stopping existing app containers (preserving Drone CI)..."
          # Only stop containers defined in the compose file, not Drone CI containers
          docker compose -f $COMPOSE_FILE stop || echo "‚ö†Ô∏è  No existing containers to stop"
          docker compose -f $COMPOSE_FILE rm -f || echo "‚ö†Ô∏è  No containers to remove"
          
          echo "üöÄ Starting services with $COMPOSE_FILE..."
          docker compose -f $COMPOSE_FILE up -d --remove-orphans
          
          echo "üîß Applying database migrations..."
          # Wait for databases to be ready
          sleep 10
          
          # Fix users_role_check constraint to include CONTROLLER role
          if docker ps | grep -q "user-service-postgres"; then
            echo "Applying User service database migration..."
            docker exec user-service-postgres psql -U postgres -d user_db -c "
              ALTER TABLE users DROP CONSTRAINT IF EXISTS users_role_check;
              ALTER TABLE users ADD CONSTRAINT users_role_check 
                CHECK (role IN ('PASSENGER', 'DRIVER', 'CONTROLLER', 'ADMIN'));
            " || echo "‚ö†Ô∏è  Migration already applied or database not ready"
          fi
          
          echo "‚úÖ Deployment complete!"
          docker compose -f $COMPOSE_FILE ps
        DEPLOYSCRIPT
    depends_on:
      - detect-changed-services
      - build-user-service
      - build-ticket-service
      - build-subscription-service
      - build-route-service
      - build-bus-geolocation-service
      - build-notification-service
      - build-api-gateway
    when:
      event:
        - push
        - custom
      branch:
        - master

volumes:
  - name: maven-cache
    temp: {}

