kind: pipeline
type: docker
name: build-and-deploy

# Enable cancellation support
concurrency:
  limit: 1

steps:
  - name: detect-changed-services
    image: alpine/git:latest
    commands:
      - apk add --no-cache bash
      - |
        echo "ðŸ” Detecting changed services..."
        CHANGED_SERVICES=""
        
        # Get list of changed files compared to previous commit
        if [ "$DRONE_COMMIT_BEFORE" != "0000000000000000000000000000000000000000" ]; then
          CHANGED_FILES=$(git diff --name-only $DRONE_COMMIT_BEFORE $DRONE_COMMIT_AFTER || git diff --name-only HEAD~1 HEAD)
        else
          # First commit or no previous commit, check all files
          CHANGED_FILES=$(git ls-files)
        fi
        
        # Detect which services changed
        echo "$CHANGED_FILES" | grep -q "^User/" && CHANGED_SERVICES="$CHANGED_SERVICES user-service" || true
        echo "$CHANGED_FILES" | grep -q "^Ticket/" && CHANGED_SERVICES="$CHANGED_SERVICES ticket-service" || true
        echo "$CHANGED_FILES" | grep -q "^Subscription/" && CHANGED_SERVICES="$CHANGED_SERVICES subscription-service" || true
        echo "$CHANGED_FILES" | grep -q "^Route/" && CHANGED_SERVICES="$CHANGED_SERVICES route-service" || true
        echo "$CHANGED_FILES" | grep -q "^BusGeolocation/" && CHANGED_SERVICES="$CHANGED_SERVICES bus-geolocation-service" || true
        echo "$CHANGED_FILES" | grep -q "^Notification/" && CHANGED_SERVICES="$CHANGED_SERVICES notification-service" || true
        echo "$CHANGED_FILES" | grep -q "^api-gateway/" && CHANGED_SERVICES="$CHANGED_SERVICES api-gateway" || true
        echo "$CHANGED_FILES" | grep -q "^Frontend/" && CHANGED_SERVICES="$CHANGED_SERVICES frontend" || true
        echo "$CHANGED_FILES" | grep -q "^pom.xml\|^\.drone.yml\|^docker-compose" && CHANGED_SERVICES="all" || true
        
        # If no specific services changed but root files changed, rebuild all
        if [ -z "$CHANGED_SERVICES" ]; then
          CHANGED_SERVICES="all"
        fi
        
        # Trim whitespace
        CHANGED_SERVICES=$(echo $CHANGED_SERVICES | xargs)
        
        echo "ðŸ“¦ Changed services: $CHANGED_SERVICES"
        echo "CHANGED_SERVICES=$CHANGED_SERVICES" > /drone/src/changed_services.txt
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-user-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "user-service"; then
          echo "ðŸ”¨ Building User service..."
          mvn clean package -DskipTests -pl User -am
          echo "âœ… User service build completed"
        else
          echo "â­ï¸  User service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-ticket-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "ticket-service"; then
          echo "ðŸ”¨ Building Ticket service..."
          mvn clean package -DskipTests -pl Ticket -am
          echo "âœ… Ticket service build completed"
        else
          echo "â­ï¸  Ticket service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-subscription-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "subscription-service"; then
          echo "ðŸ”¨ Building Subscription service..."
          mvn clean package -DskipTests -pl Subscription -am
          echo "âœ… Subscription service build completed"
        else
          echo "â­ï¸  Subscription service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-route-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "route-service"; then
          echo "ðŸ”¨ Building Route service..."
          mvn clean package -DskipTests -pl Route -am
          echo "âœ… Route service build completed"
        else
          echo "â­ï¸  Route service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-bus-geolocation-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "bus-geolocation-service"; then
          echo "ðŸ”¨ Building BusGeolocation service..."
          mvn clean package -DskipTests -pl BusGeolocation -am
          echo "âœ… BusGeolocation service build completed"
        else
          echo "â­ï¸  BusGeolocation service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-notification-service
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "notification-service"; then
          echo "ðŸ”¨ Building Notification service..."
          mvn clean package -DskipTests -pl Notification -am
          echo "âœ… Notification service build completed"
          ls -la Notification/target/*.jar || echo "âš ï¸  Notification JAR not found!"
        else
          echo "â­ï¸  Notification service unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: build-api-gateway
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - |
        CHANGED_SERVICES=$(cat /drone/src/changed_services.txt 2>/dev/null | grep CHANGED_SERVICES= | cut -d'=' -f2 || echo "all")
        if [ "$CHANGED_SERVICES" = "all" ] || echo "$CHANGED_SERVICES" | grep -q "api-gateway"; then
          echo "ðŸ”¨ Building API Gateway..."
          mvn clean package -DskipTests -pl api-gateway -am
          echo "âœ… API Gateway build completed"
        else
          echo "â­ï¸  API Gateway unchanged, skipping build"
        fi
    depends_on:
      - detect-changed-services
    when:
      event:
        - push
        - pull_request
        - custom

  - name: deploy-to-vps
    image: alpine/git:latest
    environment:
      VPS_HOST:
        from_secret: vps_host
      VPS_USER:
        from_secret: vps_user
      VPS_SSH_KEY:
        from_secret: vps_ssh_key
      DOCKER_USERNAME:
        from_secret: ghcr_username
      DOCKER_PASSWORD:
        from_secret: ghcr_token
    commands:
      - apk add --no-cache openssh-client rsync
      - mkdir -p ~/.ssh
      - echo "$$VPS_SSH_KEY" > ~/.ssh/deploy_key
      - chmod 600 ~/.ssh/deploy_key
      - ssh-keyscan -H $$VPS_HOST >> ~/.ssh/known_hosts || true
      - echo "ðŸ“¦ Copying source code to VPS..."
      - echo "VPS_HOST=$$VPS_HOST, VPS_USER=$$VPS_USER"
      - |
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          $${DRONE_WORKSPACE}/ \
          "$$VPS_USER@$$VPS_HOST:/opt/soa-bus-app/"
      - echo "ðŸš€ Building and deploying services on VPS..."
      - |
        if [ -z "$$DOCKER_USERNAME" ] || [ -z "$$DOCKER_PASSWORD" ]; then
          echo "âŒ ERROR: Docker credentials are missing!"
          exit 1
        fi
        
        COMMIT_SHA="$${DRONE_COMMIT_SHA:0:8}"
        
        # Write deployment script
        printf '#!/bin/bash\nset -e\ncd /opt/soa-bus-app\nexport DOCKER_USERNAME DOCKER_PASSWORD COMMIT_SHA\n[ -f .env ] && set -a && source .env && set +a\nCOMMIT_SHA="${COMMIT_SHA:-$(git rev-parse --short=8 HEAD 2>/dev/null || echo latest)}"\necho "$DOCKER_PASSWORD" | docker login ghcr.io -u "$DOCKER_USERNAME" --password-stdin || exit 1\nbuild_and_push() {\n  local SERVICE_NAME=$1 DOCKERFILE=$2 IMAGE_NAME=$3 BUILD_ARGS=$4\n  local IMAGE_TAG="ghcr.io/$DOCKER_USERNAME/$IMAGE_NAME"\n  local TAG_SHA="$COMMIT_SHA"\n  echo "ðŸ”¨ Building $SERVICE_NAME: ${IMAGE_TAG}:${TAG_SHA}"\n  if [ -n "$BUILD_ARGS" ]; then\n    docker build $BUILD_ARGS -t "${IMAGE_TAG}:${TAG_SHA}" -t "${IMAGE_TAG}:latest" -f "$DOCKERFILE" . || return 1\n  else\n    docker build -t "${IMAGE_TAG}:${TAG_SHA}" -t "${IMAGE_TAG}:latest" -f "$DOCKERFILE" . || return 1\n  fi\n  echo "ðŸ“¤ Pushing $SERVICE_NAME..."\n  docker push "${IMAGE_TAG}:${TAG_SHA}" && docker push "${IMAGE_TAG}:latest"\n}\nbuild_and_push user-service User/Dockerfile soa-bus-app-user-service\nbuild_and_push ticket-service Ticket/Dockerfile soa-bus-app-ticket-service\nbuild_and_push subscription-service Subscription/Dockerfile soa-bus-app-subscription-service\nbuild_and_push route-service Route/Dockerfile soa-bus-app-route-service\nbuild_and_push bus-geolocation-service BusGeolocation/Dockerfile soa-bus-app-bus-geolocation-service\nbuild_and_push notification-service Notification/Dockerfile soa-bus-app-notification-service\nbuild_and_push api-gateway api-gateway/Dockerfile soa-bus-app-api-gateway\nbuild_and_push frontend Frontend/Dockerfile soa-bus-app-frontend "--build-arg REACT_APP_API_URL=https://nassar.clueleak.com/api/v1 --build-arg REACT_APP_USER_SERVICE_URL=https://nassar.clueleak.com/api/v1"\nCOMPOSE_FILE="docker-compose.production.yml"\n[ ! -f "$COMPOSE_FILE" ] && COMPOSE_FILE="docker-compose.yml"\necho "ðŸš€ Deploying services..."\ndocker compose -f $COMPOSE_FILE down\ndocker compose -f $COMPOSE_FILE up -d --remove-orphans\nsleep 10\ndocker exec user-service-postgres psql -U postgres -d user_db -c "ALTER TABLE users DROP CONSTRAINT IF EXISTS users_role_check; ALTER TABLE users ADD CONSTRAINT users_role_check CHECK (role IN ('"'"'PASSENGER'"'"', '"'"'DRIVER'"'"', '"'"'CONTROLLER'"'"', '"'"'ADMIN'"'"'));" 2>/dev/null || true\necho "âœ… Deployment complete!"\ndocker compose -f $COMPOSE_FILE ps\n' > /tmp/deploy.sh
        
        # Copy and execute
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no /tmp/deploy.sh "$$VPS_USER@$$VPS_HOST:/tmp/deploy.sh"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$$VPS_USER@$$VPS_HOST" \
          DOCKER_USERNAME="$$DOCKER_USERNAME" \
          DOCKER_PASSWORD="$$DOCKER_PASSWORD" \
          COMMIT_SHA="$$COMMIT_SHA" \
          "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"
    depends_on:
      - detect-changed-services
      - build-user-service
      - build-ticket-service
      - build-subscription-service
      - build-route-service
      - build-bus-geolocation-service
      - build-notification-service
      - build-api-gateway
    when:
      event:
        - push
        - custom
      branch:
        - master

volumes:
  - name: maven-cache
    temp: {}

