kind: pipeline
type: docker
name: build-and-deploy

steps:
  - name: build-backend-services
    image: maven:3.9-eclipse-temurin-17
    volumes:
      - name: maven-cache
        path: /root/.m2
    commands:
      - echo "Building all microservices..."
      - mvn clean package -DskipTests
    when:
      event:
        - push
        - pull_request

  - name: build-push-user-service
    image: docker:24-cli
    depends_on:
      - build-backend-services
    environment:
      GHCR_USERNAME:
        from_secret: ghcr_username
      GHCR_TOKEN:
        from_secret: ghcr_token
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - echo "ðŸ” Logging in to GHCR..."
      - echo "$$GHCR_TOKEN" | docker login ghcr.io -u "$$GHCR_USERNAME" --password-stdin
      - echo "ðŸ” Verifying JAR exists..."
      - ls -la User/target/*.jar || (echo "âŒ JAR not found!" && exit 1)
      - echo "ðŸ”¨ Building user-service image..."
      - docker build -t ghcr.io/ettomarett/soa-bus-app-user-service:${DRONE_COMMIT_SHA:0:8} -t ghcr.io/ettomarett/soa-bus-app-user-service:latest -f User/Dockerfile .
      - echo "ðŸ“¤ Pushing to GHCR..."
      - docker push ghcr.io/ettomarett/soa-bus-app-user-service:${DRONE_COMMIT_SHA:0:8}
      - docker push ghcr.io/ettomarett/soa-bus-app-user-service:latest
    when:
      event:
        - push
      branch:
        - master

  - name: build-push-ticket-service
    image: docker:24-cli
    depends_on:
      - build-push-user-service
    environment:
      GHCR_USERNAME:
        from_secret: ghcr_username
      GHCR_TOKEN:
        from_secret: ghcr_token
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - echo "$$GHCR_TOKEN" | docker login ghcr.io -u "$$GHCR_USERNAME" --password-stdin
      - echo "ðŸ” Verifying JAR exists..."
      - ls -la Ticket/target/*.jar || (echo "âŒ JAR not found!" && exit 1)
      - docker build -t ghcr.io/ettomarett/soa-bus-app-ticket-service:${DRONE_COMMIT_SHA:0:8} -t ghcr.io/ettomarett/soa-bus-app-ticket-service:latest -f Ticket/Dockerfile .
      - docker push ghcr.io/ettomarett/soa-bus-app-ticket-service:${DRONE_COMMIT_SHA:0:8}
      - docker push ghcr.io/ettomarett/soa-bus-app-ticket-service:latest
    when:
      event:
        - push
      branch:
        - master

  - name: build-push-subscription-service
    image: docker:24-cli
    depends_on:
      - build-push-ticket-service
    environment:
      GHCR_USERNAME:
        from_secret: ghcr_username
      GHCR_TOKEN:
        from_secret: ghcr_token
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - echo "$$GHCR_TOKEN" | docker login ghcr.io -u "$$GHCR_USERNAME" --password-stdin
      - echo "ðŸ” Verifying JAR exists..."
      - ls -la Subscription/target/*.jar || (echo "âŒ JAR not found!" && exit 1)
      - docker build -t ghcr.io/ettomarett/soa-bus-app-subscription-service:${DRONE_COMMIT_SHA:0:8} -t ghcr.io/ettomarett/soa-bus-app-subscription-service:latest -f Subscription/Dockerfile .
      - docker push ghcr.io/ettomarett/soa-bus-app-subscription-service:${DRONE_COMMIT_SHA:0:8}
      - docker push ghcr.io/ettomarett/soa-bus-app-subscription-service:latest
    when:
      event:
        - push
      branch:
        - master

  - name: build-push-route-service
    image: docker:24-cli
    depends_on:
      - build-push-subscription-service
    environment:
      GHCR_USERNAME:
        from_secret: ghcr_username
      GHCR_TOKEN:
        from_secret: ghcr_token
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - echo "$$GHCR_TOKEN" | docker login ghcr.io -u "$$GHCR_USERNAME" --password-stdin
      - echo "ðŸ” Verifying JAR exists..."
      - ls -la Route/target/*.jar || (echo "âŒ JAR not found!" && exit 1)
      - docker build -t ghcr.io/ettomarett/soa-bus-app-route-service:${DRONE_COMMIT_SHA:0:8} -t ghcr.io/ettomarett/soa-bus-app-route-service:latest -f Route/Dockerfile .
      - docker push ghcr.io/ettomarett/soa-bus-app-route-service:${DRONE_COMMIT_SHA:0:8}
      - docker push ghcr.io/ettomarett/soa-bus-app-route-service:latest
    when:
      event:
        - push
      branch:
        - master

  - name: build-push-bus-geolocation-service
    image: docker:24-cli
    depends_on:
      - build-push-route-service
    environment:
      GHCR_USERNAME:
        from_secret: ghcr_username
      GHCR_TOKEN:
        from_secret: ghcr_token
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - echo "$$GHCR_TOKEN" | docker login ghcr.io -u "$$GHCR_USERNAME" --password-stdin
      - echo "ðŸ” Verifying JAR exists..."
      - ls -la BusGeolocation/target/*.jar || (echo "âŒ JAR not found!" && exit 1)
      - docker build -t ghcr.io/ettomarett/soa-bus-app-bus-geolocation-service:${DRONE_COMMIT_SHA:0:8} -t ghcr.io/ettomarett/soa-bus-app-bus-geolocation-service:latest -f BusGeolocation/Dockerfile .
      - echo "ðŸ“¤ Pushing to GHCR..."
      - docker push ghcr.io/ettomarett/soa-bus-app-bus-geolocation-service:${DRONE_COMMIT_SHA:0:8}
      - docker push ghcr.io/ettomarett/soa-bus-app-bus-geolocation-service:latest
    when:
      event:
        - push
      branch:
        - master

  - name: build-push-api-gateway
    image: docker:24-cli
    depends_on:
      - build-push-bus-geolocation-service
    environment:
      GHCR_USERNAME:
        from_secret: ghcr_username
      GHCR_TOKEN:
        from_secret: ghcr_token
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - echo "$$GHCR_TOKEN" | docker login ghcr.io -u "$$GHCR_USERNAME" --password-stdin
      - echo "ðŸ” Verifying JAR exists..."
      - ls -la api-gateway/target/*.jar || (echo "âŒ JAR not found!" && exit 1)
      - echo "ðŸ”¨ Building api-gateway image..."
      - docker build -t ghcr.io/ettomarett/soa-bus-app-api-gateway:${DRONE_COMMIT_SHA:0:8} -t ghcr.io/ettomarett/soa-bus-app-api-gateway:latest -f api-gateway/Dockerfile .
      - echo "ðŸ“¤ Pushing to GHCR..."
      - docker push ghcr.io/ettomarett/soa-bus-app-api-gateway:${DRONE_COMMIT_SHA:0:8}
      - docker push ghcr.io/ettomarett/soa-bus-app-api-gateway:latest
    when:
      event:
        - push
      branch:
        - master

  - name: build-push-frontend
    image: docker:24-cli
    depends_on:
      - build-push-api-gateway
    environment:
      GHCR_USERNAME:
        from_secret: ghcr_username
      GHCR_TOKEN:
        from_secret: ghcr_token
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - echo "ðŸ” Logging in to GHCR..."
      - echo "$$GHCR_TOKEN" | docker login ghcr.io -u "$$GHCR_USERNAME" --password-stdin
      - echo "ðŸ”¨ Building frontend image..."
      - docker build -t ghcr.io/ettomarett/soa-bus-app-frontend:${DRONE_COMMIT_SHA:0:8} -t ghcr.io/ettomarett/soa-bus-app-frontend:latest -f Frontend/Dockerfile .
      - echo "ðŸ“¤ Pushing to GHCR..."
      - docker push ghcr.io/ettomarett/soa-bus-app-frontend:${DRONE_COMMIT_SHA:0:8}
      - docker push ghcr.io/ettomarett/soa-bus-app-frontend:latest
    when:
      event:
        - push
      branch:
        - master

  - name: deploy-to-vps
    image: alpine/git:latest
    environment:
      VPS_HOST:
        from_secret: vps_host
      VPS_USER:
        from_secret: vps_user
      VPS_SSH_KEY:
        from_secret: vps_ssh_key
      DOCKER_USERNAME:
        from_secret: ghcr_username
      DOCKER_PASSWORD:
        from_secret: ghcr_token
    commands:
      - apk add --no-cache openssh-client rsync
      - mkdir -p ~/.ssh
      - echo "$$VPS_SSH_KEY" > ~/.ssh/deploy_key
      - chmod 600 ~/.ssh/deploy_key
      - ssh-keyscan -H $$VPS_HOST >> ~/.ssh/known_hosts || true
      - echo "ðŸ“¦ Copying source code to VPS..."
      - echo "VPS_HOST=$$VPS_HOST, VPS_USER=$$VPS_USER"
      - |
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          $${DRONE_WORKSPACE}/ \
          "$$VPS_USER@$$VPS_HOST:/opt/soa-bus-app/"
      - echo "ðŸš€ Deploying services on VPS..."
      - |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$$VPS_USER@$$VPS_HOST" << EOF
          cd /opt/soa-bus-app
          set -a && source .env && set +a
          echo "ðŸ” Logging in to GHCR..."
          echo "${DOCKER_PASSWORD}" | docker login ghcr.io -u "${DOCKER_USERNAME}" --password-stdin
          echo "ðŸ“¥ Pulling latest images..."
          docker compose -f docker-compose.production.yml pull
          echo "ðŸš€ Starting services..."
          docker compose -f docker-compose.production.yml up -d
          echo "âœ… Deployment complete!"
          docker compose -f docker-compose.production.yml ps
        EOF
    depends_on:
      - build-push-user-service
      - build-push-ticket-service
      - build-push-subscription-service
      - build-push-route-service
      - build-push-bus-geolocation-service
      - build-push-api-gateway
      - build-push-frontend
    when:
      event:
        - push
      branch:
        - master

volumes:
  - name: maven-cache
    temp: {}
  - name: docker-sock
    temp: {}

